import networkx as nx
from datetime import datetime

class GraphBuilder:
    def __init__(self):
        # in-memory cache: vendorId -> DiGraph (for quick response)
        self.graphs = {}

    def add_event(self, vendor_id, event_type, metadata=None):
        if vendor_id not in self.graphs:
            self.graphs[vendor_id] = nx.DiGraph()
            self.graphs[vendor_id].add_node("vendor:"+vendor_id, type="vendor")

        G = self.graphs[vendor_id]
        ts = datetime.utcnow().isoformat()
        event_node = f"event:{event_type}:{ts}"
        G.add_node(event_node, type="event", eventType=event_type, metadata=metadata or {}, timestamp=ts)
        G.add_edge("vendor:"+vendor_id, event_node, relation="performed", timestamp=ts)

        last = G.graph.get("last_event")
        if last:
            G.add_edge(last, event_node, relation="next", timestamp=ts)
        G.graph["last_event"] = event_node

        return G

    def get_snapshot(self, vendor_id):
        G = self.graphs.get(vendor_id)
        if not G:
            return {"nodes": [], "edges": []}
        nodes = list(G.nodes())
        edges = [(u, v) for u, v in G.edges()]
        return {"nodes": nodes, "edges": edges}

    def set_from_snapshot(self, vendor_id, nodes, edges):
        G = nx.DiGraph()
        for n in nodes:
            G.add_node(n)
        for u,v in edges:
            G.add_edge(u,v)
        self.graphs[vendor_id] = G
        return G
